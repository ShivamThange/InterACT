<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Crypto Ecosystem: A Visual Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Lato', sans-serif;
            background-color: #FFF8F0; /* Soft Cream */
            color: #333333; /* Dark Charcoal */
        }
        main {
            height: 100vh;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }
        .parallax-bg {
            background-image: url('https://www.transparenttextures.com/patterns/subtle-prism.png');
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            opacity: 0.1;
        }
        .content-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border-radius: 1rem;
        }
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .story-section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem 1rem;
            scroll-snap-align: start;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-toggle .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-toggle.open .chevron {
            transform: rotate(180deg);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }
        .gemini-button {
            background-color: #FF6F61; /* Vibrant Coral */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
            border: none;
            cursor: pointer;
        }
        .gemini-button:hover {
            background-color: #E66054;
            transform: scale(1.05);
        }
        .gemini-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: scale(1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF6F61; /* Vibrant Coral */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased leading-relaxed">
    <div class="parallax-bg"></div>
    <main class="relative">
        
        <header class="story-section text-center">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-5xl md:text-7xl font-bold text-gray-800">A Visual Analysis of the Crypto Ecosystem</h1>
                <p class="mt-6 text-xl text-gray-600">From a cypherpunk vision to a multi-trillion dollar asset class challenging the foundations of global finance.</p>
                <div class="mt-12 animate-bounce">
                    <svg class="w-8 h-8 text-gray-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </div>
        </header>

        <section id="genesis" class="story-section bg-white/30">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl font-bold mb-4 text-gray-800">It Started With an Idea</h2>
                <p class="text-lg text-gray-600 mb-12">Before there was Bitcoin, there was a dream: digital money that no bank or government could control. This section explores the key milestones that turned that dream into a reality.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="content-card p-6">
                        <h3 class="text-2xl font-bold text-[#008080]">1983-1998</h3>
                        <p class="font-semibold mt-2">The Cypherpunks</p>
                        <p class="text-sm text-gray-600 mt-2">Privacy advocates and cryptographers imagined 'ecash', laying the groundwork for anonymous digital money.</p>
                    </div>
                    <div class="content-card p-6">
                        <h3 class="text-2xl font-bold text-[#008080]">2009</h3>
                        <p class="font-semibold mt-2">Bitcoin is Born</p>
                        <p class="text-sm text-gray-600 mt-2">The mysterious Satoshi Nakamoto releases Bitcoin, solving the "double-spending" problem with a technology called blockchain.</p>
                    </div>
                    <div class="content-card p-6">
                        <h3 class="text-2xl font-bold text-[#008080]">2015</h3>
                        <p class="font-semibold mt-2">Ethereum's Revolution</p>
                        <p class="text-sm text-gray-600 mt-2">Ethereum introduces "smart contracts," turning blockchain into a global computer for building unstoppable applications.</p>
                    </div>
                    <div class="content-card p-6">
                        <h3 class="text-2xl font-bold text-[#008080]">2024</h3>
                        <p class="font-semibold mt-2">Wall Street Arrives</p>
                        <p class="text-sm text-gray-600 mt-2">The U.S. approves Bitcoin ETFs, creating a regulated bridge for mainstream investors to enter the crypto market.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="market-scale" class="story-section">
            <div class="max-w-4xl mx-auto w-full">
                <h2 class="text-4xl font-bold text-center mb-4 text-gray-800">How Big is Crypto, Really?</h2>
                <p class="text-lg text-gray-600 text-center mb-12">The crypto market's value has exploded, but it's a volatile ride. These charts show the scale of its growth and which assets dominate the landscape.</p>
                
                <div class="space-y-4">
                    <div class="content-card">
                        <button class="accordion-toggle w-full p-6 text-left flex justify-between items-center" data-chart-id="marketCapChart">
                            <h3 class="text-2xl font-bold">Market Cap Growth: A Volatile Rocket Ship</h3>
                            <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-6 pt-0">
                                <p class="text-sm text-gray-600 mb-4">"Market Cap" is the total value of all coins combined. It shows the incredible growth from a niche hobby to a multi-trillion dollar industry, but also highlights the dramatic boom-and-bust cycles.</p>
                                <div class="chart-container">
                                    <canvas id="marketCapChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <button class="accordion-toggle w-full p-6 text-left flex justify-between items-center" data-chart-id="marketDominanceChart">
                            <h3 class="text-2xl font-bold">Market Dominance: The Kings and Contenders</h3>
                             <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-6 pt-0">
                                <p class="text-sm text-gray-600 mb-4">While thousands of "altcoins" exist, the market is heavily concentrated. Bitcoin remains king, but Ethereum, stablecoins (digital dollars), and other projects command significant shares.</p>
                                <div class="chart-container">
                                    <canvas id="marketDominanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="regulation" class="story-section bg-white/30">
             <div class="max-w-4xl mx-auto w-full">
                <h2 class="text-4xl font-bold text-center mb-4 text-gray-800">The World Lays Down the Law</h2>
                <p class="text-lg text-gray-600 text-center mb-12">Governments can't ignore crypto anymore. But how do you regulate a borderless technology? The answer is complicated, with each country taking a wildly different approach.</p>
                
                <div class="space-y-4">
                    <div class="content-card">
                        <button class="accordion-toggle w-full p-6 text-left flex justify-between items-center" data-chart-id="regulationRadarChart">
                            <h3 class="text-2xl font-bold">National Approaches: A Global Tug-of-War</h3>
                             <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-6 pt-0">
                                <p class="text-sm text-gray-600 mb-4">This chart compares how different nations are handling crypto. Some, like the EU, are creating clear rules. Others, like the US, are still figuring it out, while countries like China have banned it outright.</p>
                                <div class="chart-container">
                                    <canvas id="regulationRadarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="impact" class="story-section">
            <div class="max-w-4xl mx-auto w-full">
                <h2 class="text-4xl font-bold text-center mb-4 text-gray-800">The Double-Edged Sword</h2>
                <p class="text-lg text-gray-600 text-center mb-12">Crypto's integration into the real world brings both huge opportunities and serious risks. It's a technology with the power to build and to break.</p>
                
                <div class="space-y-4">
                    <div class="content-card">
                        <button class="accordion-toggle w-full p-6 text-left flex justify-between items-center" data-chart-id="derivativesDonutChart">
                            <h3 class="text-2xl font-bold">Systemic Risk: When Bets Get Too Big</h3>
                             <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-6 pt-0">
                                <div class="flex justify-between items-start mb-4">
                                    <p class="text-sm text-gray-600 flex-grow pr-4">The market for "derivatives" (bets on crypto's future price) is 4x larger than the market for buying crypto itself. This creates a hidden risk: a crash in this leveraged betting market could spill over into traditional finance.</p>
                                    <button class="gemini-button explain-button" data-context="Systemic Risk: The market for derivatives (bets on crypto's future price) is 4x larger than the market for buying crypto itself. This creates a hidden risk: a crash in this leveraged betting market could spill over into traditional finance.">✨ Explain</button>
                                </div>
                                <div class="chart-container">
                                    <canvas id="derivativesDonutChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="content-card">
                        <button class="accordion-toggle w-full p-6 text-left flex justify-between items-center" data-chart-id="illicitFinanceBarChart">
                            <h3 class="text-2xl font-bold">Illicit Use: The Dark Side</h3>
                             <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <div class="p-6 pt-0">
                                <p class="text-sm text-gray-600 mb-4">While most crypto use is legitimate, its anonymity appeals to criminals. Scams, fraud, and ransomware are major problems that regulators are trying to crack down on.</p>
                                <div class="chart-container">
                                    <canvas id="illicitFinanceBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="casestudy" class="story-section bg-white/30">
            <div class="max-w-4xl mx-auto w-full">
                <h2 class="text-4xl font-bold text-center mb-4 text-gray-800">Case Study: El Salvador's Gamble</h2>
                <p class="text-lg text-gray-600 text-center mb-12">In 2021, El Salvador did something radical: it made Bitcoin an official currency. It was a bold real-world test of crypto's promise. Here's what happened.</p>
                <div class="content-card p-6">
                    <h3 class="text-2xl font-bold text-center mb-4">Adoption & Inclusion Goals Missed</h3>
                    <p class="text-center text-sm text-gray-600 mb-4">Despite a government mandate, usage for daily transactions and remittances remained negligible, failing to bank the unbanked.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="chart-container h-64">
                            <canvas id="elSalvadorAdoptionChart"></canvas>
                        </div>
                        <div class="chart-container h-64">
                            <canvas id="chivoAtmChart"></canvas>
                        </div>
                    </div>
                     <div class="mt-8">
                        <button class="accordion-toggle w-full p-4 text-left flex justify-between items-center bg-gray-100 rounded-lg">
                            <h4 class="text-xl font-bold">What Went Wrong? Key Takeaways</h4>
                             <svg class="chevron w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content">
                            <ul class="space-y-4 p-4">
                                <li class="flex items-start">
                                    <div class="icon-circle bg-[#F4C2C2] flex-shrink-0 text-red-800">✗</div>
                                    <span class="ml-4 text-gray-700"><strong>Tech isn't a silver bullet.</strong> Bitcoin couldn't solve deep-rooted economic problems overnight.</span>
                                </li>
                                <li class="flex items-start">
                                    <div class="icon-circle bg-[#F4C2C2] flex-shrink-0 text-red-800">✗</div>
                                    <span class="ml-4 text-gray-700"><strong>Trust is everything.</strong> Without proper education and a reliable app, most people were too hesitant to use it.</span>
                                </li>
                                <li class="flex items-start">
                                    <div class="icon-circle bg-[#F4C2C2] flex-shrink-0 text-red-800">✗</div>
                                    <span class="ml-4 text-gray-700"><strong>Old money still has power.</strong> Global institutions like the IMF pressured El Salvador, ultimately leading them to reverse the law.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="community" class="story-section">
            <div class="max-w-4xl mx-auto w-full">
                 <h2 class="text-4xl font-bold text-center mb-4 text-gray-800">Community Reactions</h2>
                 <p class="text-lg text-gray-600 text-center mb-6">Join the conversation! Share your thoughts on the crypto ecosystem. Comments are public and update in real-time.</p>
                 <div class="bg-white/80 p-4 rounded-lg mb-4 text-sm text-center">
                     Your User ID: <strong id="user-id-display" class="break-all">Loading...</strong>
                 </div>
                 <div class="content-card p-6">
                     <div id="comment-form">
                         <textarea id="comment-input" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#AEC6CF] focus:outline-none" rows="3" placeholder="What's on your mind?"></textarea>
                         <button id="submit-comment" class="gemini-button mt-2 px-6 py-2">Submit</button>
                     </div>
                     <div id="comments-list" class="mt-6 space-y-4 max-h-96 overflow-y-auto">
                        <div id="comments-loader" class="mx-auto loader"></div>
                     </div>
                 </div>
            </div>
        </section>

        <footer class="story-section text-center bg-white/30">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-4xl font-bold mb-8 text-gray-800">The Unwritten Future</h2>
                <p class="text-lg text-gray-600 mb-12">The crypto story is far from over. As technology and regulation continue to evolve, three major questions will define the next chapter.</p>
                <div id="future-questions" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-6">
                        <h4 class="font-bold text-xl mb-2">1. The DeFi Question</h4>
                        <p class="text-gray-600">How will new laws affect truly decentralized apps that have no central company to regulate?</p>
                    </div>
                    <div class="p-6">
                        <h4 class="font-bold text-xl mb-2">2. The Systemic Risk Question</h4>
                        <p class="text-gray-600">Are rules keeping up with the massive, risky bets being made in the offshore derivatives market?</p>
                    </div>
                    <div class="p-6">
                        <h4 class="font-bold text-xl mb-2">3. The Geopolitical Question</h4>
                        <p class="text-gray-600">How will the battle between the Dollar, a digital Euro, and China's e-CNY affect Bitcoin's future?</p>
                    </div>
                </div>
                <div class="mt-12">
                    <button id="forecast-button" class="gemini-button text-lg px-8 py-4">✨ Forecast Future Trends</button>
                </div>
                <div id="forecast-loader" class="hidden mx-auto mt-8 loader"></div>
                <div id="forecast-results" class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </footer>
    </main>

    <div id="explanation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
            <div id="modal-loader" class="mx-auto loader"></div>
            <p id="modal-explanation" class="text-gray-600"></p>
            <button id="modal-close" class="mt-6 gemini-button">Got it!</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const palette = {
                coral: '#FF6F61',
                teal: '#008080',
                softBlue: '#AEC6CF',
                dustyRose: '#F4C2C2',
                charcoal: '#333333',
                lightGray: '#ADB5BD'
            };

            // --- Chart Options and Helpers (Defined First) ---
            const wrapLabel = (str, maxLen = 16) => {
                if (typeof str !== 'string' || str.length <= maxLen) return str;
                const words = str.split(' ');
                const lines = [];
                let currentLine = '';
                for (const word of words) {
                    if ((currentLine + word).length > maxLen && currentLine.length > 0) {
                        lines.push(currentLine.trim());
                        currentLine = '';
                    }
                    currentLine += word + ' ';
                }
                lines.push(currentLine.trim());
                return lines;
            };

            const tooltipConfig = {
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                let label = item.chart.data.labels[item.dataIndex];
                                return Array.isArray(label) ? label.join(' ') : label;
                            }
                        }
                    }
                }
            };

            const baseChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: palette.charcoal, font: { family: "'Lato', sans-serif" } } },
                    ...tooltipConfig.plugins
                }
            };

            const cartesianChartOptions = {
                ...baseChartOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { color: palette.lightGray, font: { family: "'Lato', sans-serif" } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: palette.lightGray, font: { family: "'Lato', sans-serif" } }
                    }
                }
            };
            
            const radarChartOptions = {
                ...baseChartOptions,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        pointLabels: { color: palette.charcoal, font: { size: 12, family: "'Lato', sans-serif" } },
                        ticks: { color: palette.charcoal, backdropColor: 'rgba(255, 248, 240, 0.75)' }
                    }
                }
            };
            
            // --- Chart Initializers (Depend on options above) ---
            const chartInstances = {};
            const chartInitializers = {
                marketCapChart: () => {
                    const ctx = document.getElementById('marketCapChart').getContext('2d');
                    return new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['2015', '2017', '2019', '2021', '2023', '2025'],
                            datasets: [{
                                label: 'Total Market Cap (Trillion USD)',
                                data: [0.007, 0.14, 0.2, 2.5, 1.2, 4.0],
                                borderColor: palette.coral,
                                backgroundColor: 'rgba(255, 111, 97, 0.2)',
                                fill: true,
                                tension: 0.4,
                            }]
                        },
                        options: cartesianChartOptions
                    });
                },
                marketDominanceChart: () => {
                     const ctx = document.getElementById('marketDominanceChart').getContext('2d');
                     return new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Bitcoin', 'Ethereum', 'Stablecoins', 'Other Altcoins'],
                            datasets: [{
                                label: 'Market Share %',
                                data: [45, 18, 12, 25],
                                backgroundColor: [palette.teal, palette.softBlue, palette.dustyRose, palette.lightGray],
                                borderRadius: 4,
                            }]
                        },
                        options: { ...cartesianChartOptions, plugins: { ...cartesianChartOptions.plugins, legend: { display: false } } }
                    });
                },
                regulationRadarChart: () => {
                    const ctx = document.getElementById('regulationRadarChart').getContext('2d');
                    return new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['Legal Clarity', 'Favorable Tax', 'Clear Regulation', 'Light Enforcement', 'Pro-Innovation'],
                            datasets: [
                                { label: 'EU (MiCAR)', data: [4, 3, 5, 4, 4], backgroundColor: 'rgba(0, 128, 128, 0.2)', borderColor: palette.teal },
                                { label: 'USA (Post-GENIUS)', data: [3, 3, 4, 2, 4], backgroundColor: 'rgba(174, 198, 207, 0.2)', borderColor: palette.softBlue },
                                { label: 'China (Ban)', data: [1, 1, 1, 1, 1], backgroundColor: 'rgba(244, 194, 194, 0.2)', borderColor: palette.dustyRose }
                            ]
                        },
                        options: radarChartOptions
                    });
                },
                derivativesDonutChart: () => {
                    const ctx = document.getElementById('derivativesDonutChart').getContext('2d');
                    return new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Derivatives Market', 'Spot Market'],
                            datasets: [{
                                data: [1.33, 0.34],
                                backgroundColor: [palette.coral, palette.softBlue],
                                borderColor: '#FFF8F0',
                                borderWidth: 4
                            }]
                        },
                        options: baseChartOptions
                    });
                },
                illicitFinanceBarChart: () => {
                    const ctx = document.getElementById('illicitFinanceBarChart').getContext('2d');
                    return new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: [wrapLabel('Fraud & Scams (Annual)'), wrapLabel('Ransomware (Annual)'), wrapLabel('State-Sponsored Theft (Total)')],
                            datasets: [{
                                label: 'Value in Billion USD',
                                data: [51, 0.9, 3.5],
                                backgroundColor: [palette.coral, palette.teal, palette.charcoal],
                                borderRadius: 4
                            }]
                        },
                        options: { ...baseChartOptions, indexAxis: 'y', plugins: { ...baseChartOptions.plugins, legend: { display: false } }, scales: { x: { ...cartesianChartOptions.scales.x, beginAtZero: true }, y: { ...cartesianChartOptions.scales.y, grid: { display: false } } } }
                    });
                },
                elSalvadorAdoptionChart: () => {
                     const ctx = document.getElementById('elSalvadorAdoptionChart').getContext('2d');
                     return new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Unbanked (Goal)', 'Consumer Use', 'Remittance Use'],
                            datasets: [{
                                label: 'Percentage (%)',
                                data: [70, 12, 1],
                                backgroundColor: [palette.lightGray, palette.softBlue, palette.dustyRose],
                                borderRadius: 4
                            }]
                        },
                        options: { ...cartesianChartOptions, plugins: { ...cartesianChartOptions.plugins, legend: { display: false } }, scales: { ...cartesianChartOptions.scales, y: {...cartesianChartOptions.scales.y, ticks: { ...cartesianChartOptions.scales.y.ticks, callback: (v) => v+'%' } } } }
                    });
                },
                chivoAtmChart: () => {
                    const ctx = document.getElementById('chivoAtmChart').getContext('2d');
                    return new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['ATMs in Poorest Rural Areas', 'ATMs Elsewhere'],
                            datasets: [{
                                data: [4.9, 95.1],
                                backgroundColor: [palette.dustyRose, palette.softBlue],
                                borderColor: '#FFF8F0',
                                borderWidth: 4
                            }]
                        },
                        options: baseChartOptions
                    });
                }
            };

            // --- Firebase Integration ---
            let db, auth;
            let userId = null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                    throw new Error("Firebase config not provided.");
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        listenForComments();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const communitySection = document.getElementById('community');
                if(communitySection) {
                    communitySection.innerHTML = `<div class="max-w-4xl mx-auto w-full text-center"><h2 class="text-4xl font-bold mb-4 text-gray-800">Community Reactions</h2><div class="content-card p-6"><p class="text-red-500">Community features are unavailable in this environment.</p></div></div>`;
                }
            }

            const commentInput = document.getElementById('comment-input');
            const submitButton = document.getElementById('submit-comment');
            const commentsList = document.getElementById('comments-list');
            const commentsLoader = document.getElementById('comments-loader');

            if(submitButton) {
                submitButton.addEventListener('click', async () => {
                    const commentText = commentInput.value.trim();
                    if (!commentText || !userId) return;

                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';

                    try {
                        const commentsCollectionPath = `artifacts/${appId}/public/data/comments`;
                        await addDoc(collection(db, commentsCollectionPath), {
                            text: commentText,
                            author: userId,
                            createdAt: serverTimestamp()
                        });
                        commentInput.value = '';
                    } catch (error) {
                        console.error("Error adding comment: ", error);
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit';
                    }
                });
            }

            function listenForComments() {
                if (!db) return;
                const commentsCollectionPath = `artifacts/${appId}/public/data/comments`;
                const q = query(collection(db, commentsCollectionPath), orderBy('createdAt', 'desc'));

                onSnapshot(q, (snapshot) => {
                    if(commentsLoader) commentsLoader.style.display = 'none';
                    if(commentsList) commentsList.innerHTML = '';
                    if (snapshot.empty) {
                        if(commentsList) commentsList.innerHTML = '<p class="text-center text-gray-500">No comments yet. Be the first!</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const comment = doc.data();
                        const commentEl = document.createElement('div');
                        commentEl.className = 'bg-gray-50 p-3 rounded-lg border';
                        
                        const authorEl = document.createElement('p');
                        authorEl.className = 'text-xs text-gray-500 break-all';
                        authorEl.textContent = `From: ${comment.author}`;
                        
                        const textEl = document.createElement('p');
                        textEl.className = 'text-gray-700';
                        textEl.textContent = comment.text;

                        commentEl.appendChild(authorEl);
                        commentEl.appendChild(textEl);
                        if(commentsList) commentsList.appendChild(commentEl);
                    });
                }, (error) => {
                    console.error("Error listening for comments:", error);
                    if(commentsList) commentsList.innerHTML = '<p class="text-center text-red-500">Error loading comments.</p>';
                });
            }


            // --- Gemini API Integration ---
            const modal = document.getElementById('explanation-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalExplanation = document.getElementById('modal-explanation');
            const modalLoader = document.getElementById('modal-loader');
            const modalClose = document.getElementById('modal-close');

            document.querySelectorAll('.explain-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const context = e.target.dataset.context;
                    const title = context.split(':')[0];
                    
                    modalTitle.textContent = title;
                    modalExplanation.textContent = '';
                    modalLoader.style.display = 'block';
                    modal.style.display = 'flex';

                    const prompt = `Explain the following concept to a complete beginner in one short, simple paragraph, as if you were explaining it to a 5-year-old: "${context}"`;
                    
                    try {
                        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                        const payload = { contents: chatHistory };
                        const apiKey = ""; 
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();

                        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                            modalExplanation.textContent = result.candidates[0].content.parts[0].text;
                        } else {
                            modalExplanation.textContent = 'Sorry, I could not get an explanation at this time.';
                        }
                    } catch (error) {
                        console.error("Gemini API error:", error);
                        modalExplanation.textContent = 'An error occurred while fetching the explanation.';
                    } finally {
                        modalLoader.style.display = 'none';
                    }
                });
            });

            modalClose.addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            const forecastButton = document.getElementById('forecast-button');
            const forecastLoader = document.getElementById('forecast-loader');
            const forecastResults = document.getElementById('forecast-results');
            
            forecastButton.addEventListener('click', async () => {
                forecastLoader.style.display = 'block';
                forecastButton.style.display = 'none';
                forecastResults.innerHTML = '';

                const questions = Array.from(document.querySelectorAll('#future-questions p')).map(p => p.textContent).join(' ');
                const prompt = `Based on these key questions about the future of cryptocurrency, generate three plausible, creative, and distinct future trends or scenarios we might see in the next 5 years. Present them as short, titled paragraphs. For each trend, provide a title wrapped in <h4> tags and the description in <p> tags. Questions: "${questions}"`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        const trendsHtml = result.candidates[0].content.parts[0].text;
                        const trends = trendsHtml.split('<h4>').slice(1);
                        trends.forEach(trend => {
                            const card = document.createElement('div');
                            card.className = 'content-card p-6 text-left';
                            card.innerHTML = `<h4>${trend.replace(/<\/h4>/, '</h4>')}`;
                            forecastResults.appendChild(card);
                        });
                    } else {
                        forecastResults.innerHTML = '<p class="text-center col-span-3">Could not generate trends at this time.</p>';
                    }
                } catch (error) {
                    console.error("Gemini API error:", error);
                    forecastResults.innerHTML = '<p class="text-center col-span-3">An error occurred while fetching future trends.</p>';
                } finally {
                    forecastLoader.style.display = 'none';
                }
            });


            // --- UI Logic (Accordions and Chart Init on Open) ---
            document.querySelectorAll('.accordion-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const content = toggle.nextElementSibling;
                    const chartId = toggle.dataset.chartId;

                    toggle.classList.toggle('open');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        if (chartId && !chartInstances[chartId]) {
                            chartInstances[chartId] = chartInitializers[chartId]();
                        }
                    }
                });
            });
            
            // Initialize charts that are always visible on page load
            ['elSalvadorAdoptionChart', 'chivoAtmChart'].forEach(id => {
                if(document.getElementById(id) && !chartInstances[id]) {
                    chartInstances[id] = chartInitializers[id]();
                }
            });
        });
    </script>
</body>
</html>

